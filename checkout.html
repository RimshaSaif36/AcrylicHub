<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Acrylic Hub - Secure Payment</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="checkout.css">
</head>
<body class="checkout-page">

<header>
    <div class="logo">
        <a href="index.html" class="logo-text">Acrylic Hub</a>
    </div>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="shop.html">Shop</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
            <li><a href="cart.html">Cart (<span id="cart-count">0</span>)</a></li>
        </ul>
    </nav>
</header>

<main>
    <div class="checkout-container">
        <h2>Checkout</h2>

        <!-- CART ITEMS -->
        <div class="checkout-cart">
            <h3>Your Cart</h3>
            <div class="cart-items"></div>
            <div class="cart-summary">
                <p>Subtotal: <span class="subtotal-price">PKR 0</span></p>
                <p>Shipping: <span class="shipping-price">PKR 200</span></p>
                <p><strong>Total: <span class="total-price">PKR 0</span></strong></p>
            </div>
        </div>

        <!-- CHECKOUT FORM -->
        <form class="checkout-form" id="checkout-form">
            <h3>Billing Details</h3>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="name" required>
            </div>

            <div class="form-group">
                <label>Address</label>
                <input type="text" id="address" required>
            </div>

            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="phone" required>
            </div>

            <!-- PAYMENT OPTIONS -->
            <div class="form-group">
                <label>Payment Option</label>
                <select id="payment">
                    <option value="cod">Cash on Delivery</option>
                    <option value="jazzcash">JazzCash</option>
                    <option value="easypaisa">EasyPaisa</option>
                </select>
            </div>

            <!-- PAYMENT DETAILS -->
            <div id="payment-details" style="display:none; margin-top:15px;">
                <p style="color:green; font-weight:bold;">
                    Send payment to this number: <br>
                    JazzCash / EasyPaisa: <span style="color:#000; font-size:18px;">03074040767</span>
                </p>

                <div class="form-group">
                    <label>Your JazzCash/EasyPaisa Number</label>
                    <input type="tel" id="senderNumber" placeholder="03XXXXXXXXX">
                </div>

                <div class="form-group">
                    <label>Transaction ID</label>
                    <input type="text" id="transactionId" placeholder="Enter Transaction ID">
                </div>

                <p style="color:#c00; font-size:14px;">
                    Please send payment to the above number and enter the details.
                </p>
            </div>

            <button type="submit" class="place-order-btn">Place Order</button>
        </form>
    </div>
</main>

<footer>
    <div class="footer-container">
        <div class="footer-column">
            <h3 class="logo-text">Acrylic Hub</h3>
            <p>Your one-stop shop for premium acrylic products.</p>
        </div>

        <div class="footer-column">
            <h3>Customer Service</h3>
            <ul>
                <li><a href="#">Shipping & Returns</a></li>
                <li><a href="#">FAQ</a></li>
                <li><a href="#">Support</a></li>
            </ul>
        </div>

        <div class="footer-column">
            <h3>Legal</h3>
            <ul>
                <li><a href="#">Terms of Service</a></li>
                <li><a href="#">Privacy Policy</a></li>
            </ul>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; 2025 Acrylic Hub. All Rights Reserved.</p>
    </div>
</footer>

<script src="cart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const cartItemsContainer = document.querySelector('.cart-items');
    const subtotalPriceElement = document.querySelector('.subtotal-price');
    const totalPriceElement = document.querySelector('.total-price');
    const shippingPrice = 200;

    // Render cart items
    const renderCartItems = () => {
        cartItemsContainer.innerHTML = '';
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
            subtotalPriceElement.textContent = 'PKR 0';
            totalPriceElement.textContent = `PKR ${shippingPrice}`;
            return;
        }

        let subtotal = 0;
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;

            const div = document.createElement('div');
            div.classList.add('checkout-cart-item');
            div.innerHTML = `
                <div class="item-name">${item.name} x ${item.quantity}</div>
                <div class="item-price">PKR ${itemTotal.toFixed(0)}</div>
            `;
            cartItemsContainer.appendChild(div);
        });

        subtotalPriceElement.textContent = `PKR ${subtotal}`;
        totalPriceElement.textContent = `PKR ${subtotal + shippingPrice}`;
    };

    renderCartItems();

    // Show/hide JazzCash/EasyPaisa fields
    document.getElementById("payment").addEventListener("change", function () {
        const box = document.getElementById("payment-details");
        box.style.display = (this.value === "jazzcash" || this.value === "easypaisa") ? "block" : "none";
    });

    // Handle checkout form submission
    document.getElementById('checkout-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (cart.length === 0) {
            alert('Your cart is empty!');
            return;
        }

        const paymentMethod = document.getElementById("payment").value;
        let senderNumber = "";
        let transactionId = "";

        if (paymentMethod !== "cod") {
            senderNumber = document.getElementById("senderNumber").value.trim();
            transactionId = document.getElementById("transactionId").value.trim();

            if (!senderNumber || !transactionId) {
                alert("Please enter your Payment Number and Transaction ID.");
                return;
            }

            // Check if transaction ID is already used
            try {
                const existingOrders = await fetch("https://sheetdb.io/api/v1/rxqrvvtgxbndk").then(res => res.json());
                const isUsed = existingOrders.some(order => order.transactionId === transactionId);
                if (isUsed) {
                    alert("This Transaction ID has already been used! Please use a new one.");
                    return;
                }
            } catch (error) {
                console.error("Error checking transaction ID:", error);
                alert("Could not verify transaction ID. Try again.");
                return;
            }
        }

        // Prepare order object
        const order = {
            name: document.getElementById('name').value,
            address: document.getElementById('address').value,
            phone: document.getElementById('phone').value,
            payment: paymentMethod,
            senderNumber: senderNumber,
            transactionId: transactionId,
            items: cart.map(item => `${item.name} x ${item.quantity} (PKR ${item.price})`).join(', '),
            subtotal: Number(subtotalPriceElement.textContent.replace('PKR ', '')),
            shipping: shippingPrice,
            total: Number(totalPriceElement.textContent.replace('PKR ', '')),
            date: new Date().toLocaleString()
        };

        try {
            await fetch("https://sheetdb.io/api/v1/rxqrvvtgxbndk", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(order)
            });

            alert("Order placed successfully!");
            cart.length = 0;
            localStorage.setItem("cart", JSON.stringify(cart));
            window.location.href = "index.html";

        } catch (error) {
            console.error(error);
            alert("Error placing order. Try again.");
        }
    });
});
</script>

</body>
</html>
